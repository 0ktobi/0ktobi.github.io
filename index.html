<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Random PDF Page Viewer</title>
  <!-- Favicon link; its href will be updated dynamically -->
  <link id="favicon" rel="icon" type="image/png" href="icons/light/four.ico">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    /* Container for toggle buttons to stay inline */
    .toggle-buttons {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    /* Make fullscreen button square and center its icon */
    #fullscreen-toggle {
      width: 2rem;
      height: 2rem;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #fullscreen-toggle img {
      display: block;
    }
  </style>
</head>
<body class="container mt-3">
  <div class="d-flex justify-content-between align-items-center">
    <h2 class="fs-5">Random PDF Page Viewer</h2>
    <div class="toggle-buttons">
      <button id="dark-mode-toggle" class="btn btn-outline-secondary btn-sm">Dark Mode</button>
      <button id="fullscreen-toggle" class="btn btn-outline-secondary btn-sm">
        <img id="fullscreen-icon" src="" alt="Fullscreen" style="width:1rem; height:1rem;">
      </button>
    </div>
  </div>

  <div id="upload-section" class="text-center mt-3">
    <input type="file" id="pdf-file" accept="application/pdf" class="form-control form-control-sm mb-2" required>
    <button id="upload-button" class="btn btn-primary btn-sm">Upload PDF</button>
  </div>

  <div id="viewer-section" style="display: none;">
    <div class="text-center mt-3">
      <h5 id="filename-display" class="fs-6"></h5>
      <button id="random-page-button" class="btn btn-success btn-sm">Get Random Page</button>
    </div>
    
    <div class="text-center mt-3">
      <h6 id="page-info" class="fs-6">Page ? of ?</h6>
      <canvas id="pdf-canvas" class="border shadow-lg" style="max-height: 75vh;"></canvas>
    </div>

    <div class="text-center mt-2">
      <button id="prev-page-button" class="btn btn-secondary btn-sm" disabled>Previous</button>
      <button id="next-page-button" class="btn btn-secondary btn-sm" disabled>Next</button>
    </div>
  </div>

  <script>
    /***** Favicon Randomizer & Dark Mode Icon Update *****/
    let currentIconPair = null;
    const iconPairs = [
      { light: 'icons/light/one.ico', dark: 'icons/dark/one.ico' },
      { light: 'icons/light/two.ico', dark: 'icons/dark/two.ico' },
      { light: 'icons/light/three.ico', dark: 'icons/dark/three.ico' },
      { light: 'icons/light/four.ico', dark: 'icons/dark/four.ico' },
      { light: 'icons/light/five.ico', dark: 'icons/dark/five.ico' },
      { light: 'icons/light/six.ico', dark: 'icons/dark/six.ico' }
    ];

    function updateFavicon() {
      const faviconEl = document.getElementById('favicon');
      if (!faviconEl || !currentIconPair) return;
      faviconEl.href = document.body.classList.contains('bg-dark')
        ? currentIconPair.dark
        : currentIconPair.light;
    }

    function selectRandomIcon() {
      currentIconPair = iconPairs[Math.floor(Math.random() * iconPairs.length)];
      updateFavicon();
    }

    /***** Fullscreen Icon Themes *****/
    const fullscreenIcons = {
      light: { expand: 'icons/light/expand.png', compress: 'icons/light/compress.png' },
      dark:  { expand: 'icons/dark/expand.png',  compress: 'icons/dark/compress.png'  }
    };
    function updateFullscreenIcon() {
      const theme = document.body.classList.contains('bg-dark') ? 'dark' : 'light';
      const isFull = !!document.fullscreenElement;
      const icon = isFull ? fullscreenIcons[theme].compress : fullscreenIcons[theme].expand;
      const altText = isFull ? 'Exit Fullscreen' : 'Fullscreen';
      $('#fullscreen-icon').attr({src: icon, alt: altText});
    }

    /***** PDF Viewer & Controls Code *****/
    let pdfDoc = null, currentPage = 1, totalPages = 0;

    $(document).ready(function() {
      // Initial setup
      selectRandomIcon();
      updateFullscreenIcon();

      // Apply persisted dark mode
      if (localStorage.getItem('darkMode') === 'enabled') {
        $('body').addClass('bg-dark text-white');
        $('#dark-mode-toggle').text('Light Mode');
        updateFavicon();
      }

      // Dark Mode Toggle
      $('#dark-mode-toggle').click(function() {
        $('body').toggleClass('bg-dark text-white');
        const dark = $('body').hasClass('bg-dark');
        localStorage.setItem('darkMode', dark ? 'enabled' : 'disabled');
        $(this).text(dark ? 'Light Mode' : 'Dark Mode');
        updateFavicon();
        updateFullscreenIcon();
      });

      // Fullscreen Toggle
      $('#fullscreen-toggle').click(() => {
        document.fullscreenElement
          ? document.exitFullscreen()
          : document.documentElement.requestFullscreen();
      });

      // Update icon on fullscreen change
      document.addEventListener('fullscreenchange', updateFullscreenIcon);

      // PDF Upload Handler
      $('#upload-button').click(function() {
        const file = $('#pdf-file')[0].files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          pdfjsLib.getDocument(e.target.result).promise.then(doc => {
            pdfDoc = doc; totalPages = doc.numPages;
            $('#upload-section').hide(); $('#viewer-section').show();
            $('#filename-display').text(`Viewing: ${file.name}`);
          });
        };
        reader.readAsArrayBuffer(file);
      });

      // Random Page
      $('#random-page-button').click(() => {
        if (!pdfDoc) return;
        currentPage = Math.floor(Math.random() * totalPages) + 1;
        renderPage(currentPage);
      });

      // Navigation Buttons
      $('#prev-page-button').click(() => navigate(-1));
      $('#next-page-button').click(() => navigate(1));

      // Keyboard Shortcuts
      $(document).keydown(e => {
        if (e.key === 'ArrowLeft') navigate(-1);
        else if (e.key === 'ArrowRight') navigate(1);
        else if (e.key === ' ' || e.key === 'Enter') $('#random-page-button').click();
        else if (e.key.toLowerCase() === 'l') $('#dark-mode-toggle').click();
      });
    });

    function renderPage(num) {
      pdfDoc.getPage(num).then(page => {
        const canvas = $('#pdf-canvas')[0], ctx = canvas.getContext('2d');
        const vp = page.getViewport({ scale: 1.5 });
        canvas.width = vp.width; canvas.height = vp.height;
        page.render({ canvasContext: ctx, viewport: vp });
        $('#page-info').text(`Page ${num} of ${totalPages}`);
        $('#prev-page-button').prop('disabled', num===1);
        $('#next-page-button').prop('disabled', num===totalPages);
      });
    }

    function navigate(delta) {
      const next = currentPage + delta;
      if (next > 0 && next <= totalPages) {
        currentPage = next; renderPage(next);
      }
    }
  </script>
</body>
</html>
